<!DOCTYPE html>
<html lang="pt-br">
<head>
       <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nao tenho nada para fazer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        body {
            background-color: #050505;
            color: #33ff33;
            font-family: 'VT323', monospace;
            font-size: 18px;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            text-shadow: 0 0 2px #004400;
        }

        /* HUD SUPERIOR */
        #hud {
            background: #001100;
            border-bottom: 2px solid #33ff33;
            padding: 10px;
            height: 180px;
            flex-shrink: 0;
            white-space: pre;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
        }
        .hud-col { display: flex; flex-direction: column; width: 33%; }
        
        /* ÁREA DE LOGS */
        #terminal-output {
            flex-grow: 1;
            padding: 20px;
            overflow-y: scroll;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%);
        }
        
        /* ESTILOS DE TEXTO */
        .line { margin-bottom: 4px; animation: fadeIn 0.1s; }
        .sys { color: #ffff55; } /* Sistema */
        .dmg { color: #ff5555; font-weight: bold; } /* Dano/Combate */
        .chat { color: #55ffff; } /* Chat Global */
        .priv { color: #ff55ff; } /* Chat Privado/Sussurro */
        .item { color: #ffa500; } /* Itens */
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* INPUT */
        #input-line {
            background: #000;
            border-top: 1px solid #33ff33;
            padding: 10px;
            display: flex;
            align-items: center;
        }
        input {
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 20px;
            width: 100%;
            outline: none;
            margin-left: 10px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <div id="hud">
        <div class="hud-col" id="hud-stats">Carregando stats...</div>
        <div class="hud-col" id="hud-loc" style="text-align: center;">Carregando local...</div>
        <div class="hud-col" id="hud-inv" style="text-align: right;">Inventário vazio</div>
    </div>

    <div id="terminal-output">
        <div class="line sys">SISTEMA INICIADO. v2.0 (MODO COMPLETO)</div>
        <div class="line sys">Digite '/help' para lista de comandos.</div>
        <div class="line sys">Use '/create sala' ou '/connect sala'.</div>
    </div>

    <div id="input-line">
        <span>USER@MIRACULOUS:~# </span>
        <input type="text" id="cmd" autofocus autocomplete="off">
    </div>

<script>
/* ==========================================================================
   CONFIGURAÇÃO & DADOS (HERÓIS, MAPA, ITENS)
   ========================================================================== */

const HEROES = {
    // ATACANTES
    cat: { name: "Gato Preto", role: "Assassino", hp: 1800, mana: 500, ad: 80, ap: 0, def: 30, res: 30 },
    mouse: { name: "Rato", role: "DPS", hp: 1600, mana: 400, ad: 75, ap: 0, def: 25, res: 25 },
    rooster: { name: "Galo", role: "Atirador", hp: 1700, mana: 450, ad: 85, ap: 0, def: 20, res: 20 },
    monkey: { name: "Macaco", role: "Lutador", hp: 2100, mana: 400, ad: 70, ap: 0, def: 40, res: 30 },
    tiger: { name: "Tigre", role: "Lutador", hp: 2000, mana: 0, ad: 90, ap: 0, def: 35, res: 35 }, // Sem mana

    // MAGOS / CONTROLE
    fox: { name: "Raposa", role: "Mago", hp: 1600, mana: 700, ad: 50, ap: 80, def: 25, res: 35 },
    bee: { name: "Abelha", role: "Controle", hp: 1700, mana: 500, ad: 60, ap: 60, def: 30, res: 30 },
    snake: { name: "Cobra", role: "Estratégico", hp: 1800, mana: 600, ad: 55, ap: 0, def: 30, res: 30 },
    dragon: { name: "Dragão", role: "Mago", hp: 1900, mana: 600, ad: 60, ap: 70, def: 35, res: 35 },
    pig: { name: "Porco", role: "Controle", hp: 1800, mana: 550, ad: 50, ap: 60, def: 30, res: 40 },

    // TANQUES
    turtle: { name: "Tartaruga", role: "Tanque", hp: 2800, mana: 400, ad: 50, ap: 0, def: 80, res: 60 },
    ox: { name: "Touro", role: "Tanque", hp: 3000, mana: 300, ad: 60, ap: 0, def: 70, res: 70 },
    
    // SUPORTES / UTILIDADE
    ladybug: { name: "Joaninha", role: "Versátil", hp: 1900, mana: 600, ad: 65, ap: 65, def: 35, res: 35 },
    butterfly: { name: "Borboleta", role: "Suporte", hp: 1700, mana: 800, ad: 40, ap: 80, def: 25, res: 30 },
    peacock: { name: "Pavão", role: "Invocador", hp: 1650, mana: 750, ad: 45, ap: 85, def: 25, res: 30 },
    goat: { name: "Cabra", role: "Suporte", hp: 1800, mana: 600, ad: 50, ap: 50, def: 40, res: 40 },
    dog: { name: "Cachorro", role: "Caçador", hp: 1850, mana: 450, ad: 70, ap: 0, def: 35, res: 30 },
    horse: { name: "Cavalo", role: "Mobilidade", hp: 1750, mana: 500, ad: 60, ap: 50, def: 30, res: 30 },
    rabbit: { name: "Coelho", role: "Especial", hp: 1600, mana: 900, ad: 50, ap: 70, def: 30, res: 30 }
};

// Mapa Graph (Conexões)
const MAP = {
    // BASES
    "base_azul": { name: "Base Aliada", type: "base", team: "blue", next: ["mid_t1", "top_t1", "bot_t1"] },
    "base_red": { name: "Base Inimiga", type: "base", team: "red", next: ["mid_t1_r", "top_t1_r", "bot_t1_r"] },
    
    // MID LANE
    "mid_t1": { name: "Torre Mid T1 (Azul)", type: "tower", team: "blue", next: ["base_azul", "mid", "matagal_mid_1"] },
    "mid": { name: "Mid Central", type: "lane", next: ["mid_t1", "mid_t1_r", "matagal_mid_1", "matagal_mid_2"] },
    "mid_t1_r": { name: "Torre Mid T1 (Red)", type: "tower", team: "red", next: ["base_red", "mid", "matagal_mid_2"] },
    "matagal_mid_1": { name: "Mato Mid Esq", type: "bush", next: ["mid", "top_river"] },
    "matagal_mid_2": { name: "Mato Mid Dir", type: "bush", next: ["mid", "bot_river"] },

    // TOP LANE (Solo)
    "top_t1": { name: "Torre Top T1 (Azul)", type: "tower", team: "blue", next: ["base_azul", "top_lane"] },
    "top_lane": { name: "Rota Top", type: "lane", next: ["top_t1", "top_t1_r", "top_river"] },
    "top_t1_r": { name: "Torre Top T1 (Red)", type: "tower", team: "red", next: ["base_red", "top_lane"] },
    
    // BOT LANE (Duo)
    "bot_t1": { name: "Torre Bot T1 (Azul)", type: "tower", team: "blue", next: ["base_azul", "bot_lane"] },
    "bot_lane": { name: "Rota Bot", type: "lane", next: ["bot_t1", "bot_t1_r", "bot_river"] },
    "bot_t1_r": { name: "Torre Bot T1 (Red)", type: "tower", team: "red", next: ["base_red", "bot_lane"] },

    // JUNGLE
    "top_river": { name: "Rio Superior (Boss)", type: "jungle", mob: "Sentimonstro", next: ["top_lane", "matagal_mid_1"] },
    "bot_river": { name: "Rio Inferior (Boss)", type: "jungle", mob: "Gorizilla", next: ["bot_lane", "matagal_mid_2"] }
};

// LOJA: Sistema de Parcelas (Craft)
// Receitas: Item Completo precisa de [partes]
const RECIPES = {
    "bastao_infinito": { name: "Bastão Infinito", cost: 1000, parts: ["varinha", "cristal"], stats: { ap: 100 } },
    "lamina_trovoada": { name: "Lâmina Trovão", cost: 1200, parts: ["adaga", "luvas"], stats: { ad: 80, as: 0.5 } },
    "armadura_titan": { name: "Armadura Titã", cost: 1100, parts: ["malha", "cinto"], stats: { def: 80, hp: 500 } }
};

const MINI_ITEMS = {
    "varinha": { name: "Varinha Aprendiz", cost: 400, stats: { ap: 20 } },
    "cristal": { name: "Cristal Mana", cost: 400, stats: { mana: 200 } },
    "adaga": { name: "Adaga Velha", cost: 450, stats: { ad: 15 } },
    "luvas": { name: "Luvas Rápidas", cost: 300, stats: { as: 0.2 } },
    "malha": { name: "Malha de Aço", cost: 300, stats: { def: 20 } },
    "cinto": { name: "Cinto Gigante", cost: 500, stats: { hp: 200 } }
};

/* ==========================================================================
   ESTADO DO JOGO
   ========================================================================== */
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD9zO9nW9NCDbucBcwwHBej9saZU9Mrw6c",
  authDomain: "servidor-e2453.firebaseapp.com",
  databaseURL: "https://servidor-e2453-default-rtdb.firebaseio.com",
  projectId: "servidor-e2453",
  storageBucket: "servidor-e2453.firebasestorage.app",
  messagingSenderId: "888960994601",
  appId: "1:888960994601:web:0417a852edfcb9f0393b38",
  measurementId: "G-20JLMYB7VV"
};

// Inicializa Firebase Mock (Para visualização sem config) ou Real
let db;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
} catch(e) {
    console.warn("Firebase não conectado. Modo Offline Simulado.");
    // Mock DB simples para testes locais
    db = { ref: () => ({ set:()=>{}, update:()=>{}, remove:()=>{}, push:()=>{}, on:()=>{} }) };
}

let roomID = null;
let myID = "p" + Math.floor(Math.random() * 9999);
let lastUpdate = Date.now();
let snapshots = []; // Histórico para o Coelho/Cobra

// Objeto do Jogador Local
let player = {
    id: myID,
    name: "Anon",
    hero: null,
    loc: "base_azul",
    lvl: 1, xp: 0,
    hp: 100, maxHp: 100,
    mana: 100, maxMana: 100,
    ad: 0, ap: 0, def: 0, res: 0,
    gold: 500,
    team: "blue",
    inventory: [], // Strings dos itens
    cooldowns: { q:0, w:0, e:0, r:0, f:0 },
    stats: { stacks: 0 }, // Para Tiger/Cat
    status: [], // "stun", "root", "immune", "burn"
    vision: [] // Locais com flores
};

// Estado Global (Outros players)
let gameState = { players: {}, events: {} };

/* ==========================================================================
   ENGINE E INPUT
   ========================================================================== */
const inputEl = document.getElementById('cmd');
inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const txt = inputEl.value.trim();
        log(txt, "sys"); // Echo
        parseCommand(txt);
        inputEl.value = '';
    }
});

function log(msg, type="line") {
    const term = document.getElementById('terminal-output');
    const div = document.createElement('div');
    div.className = `line ${type}`;
    div.innerText = msg;
    term.appendChild(div);
    term.scrollTop = term.scrollHeight;
}

function parseCommand(raw) {
    if(!raw) return;
    const parts = raw.split(' ');
    const cmd = parts[0].toLowerCase();
    const arg1 = parts[1];
    const arg2 = parts[2];

    // COMANDOS DE LOBBY
    if (cmd === '/create') {
        roomID = arg1 || "sala_teste";
        player.team = "blue"; 
        player.loc = "base_azul";
        connectDB();
        log(`Sala [${roomID}] criada. Você é TEAM BLUE.`, "sys");
        return;
    }
    if (cmd === '/connect') {
        roomID = arg1;
        player.team = "red";
        player.loc = "base_red";
        connectDB();
        log(`Conectado a [${roomID}]. Você é TEAM RED.`, "sys");
        return;
    }
    if (cmd === '/pick') {
        if(HEROES[arg1]) {
            setHero(arg1);
        } else {
            log("Herói inválido. Tente: cat, ladybug, turtle, fox...", "dmg");
        }
        return;
    }

    // COMANDOS DE JOGO
    if (!player.hero) { log("Escolha um herói com /pick {nome} primeiro!", "dmg"); return; }
    if (player.status.includes("stun") && cmd !== '/status') { log("VOCÊ ESTÁ ATORDOADO!", "dmg"); return; }

    switch(cmd) {
        // Combate
        case '/w': useSkill('w'); break;
        case '/q': useSkill('q'); break;
        case '/e': useSkill('e'); break;
        case '/r': useUlt(); break;
        case 'f': useFlash(); break;
        case '/a': attackBasic(); break;

        // Itens
        case '$': shop(arg1, arg2); break;
        case 'm': useMagicItem(arg1); break;

        // Movimento
        case '/move': move(arg1); break;
        case '/tp': teleportBase(); break;

        // Utilidade
        case '/chat':
        case '/all': sendChat("ALL", parts.slice(1).join(" ")); break;
        case '/flower': placeFlower(); break;
        case '/mapa': showMap(); break;
        case 'help': showHelp(); break;

        default: log("Comando desconhecido.", "sys");
    }
}

/* ==========================================================================
   LÓGICA DO JOGO (CORE)
   ========================================================================== */

function setHero(key) {
    const h = HEROES[key];
    player.hero = key;
    player.maxHp = h.hp; player.hp = h.hp;
    player.maxMana = h.mana; player.mana = h.mana;
    player.ad = h.ad; player.ap = h.ap;
    player.def = h.def; player.res = h.res;
    log(`Herói definido: ${h.name} [${h.role}]`, "sys");
    sync();
}

function move(dest) {
    const current = MAP[player.loc];
    let target = null;

    // Busca exata ou parcial nos vizinhos
    current.next.forEach(n => {
        if (n === dest || n.includes(dest)) target = n;
    });

    if (target) {
        player.loc = target;
        log(`Moveu para: [${MAP[target].name}]`, "sys");
        
        // Verifica se tem torre inimiga
        const locData = MAP[target];
        if (locData.type === "tower" && locData.team !== player.team) {
            log("!!! ALERTA: TORRE INIMIGA !!!", "dmg");
            // Check minions (Simulado: 50% chance de ter minions)
            if (Math.random() > 0.5) {
                log("Minions aliados tankando a torre.", "sys");
            } else {
                log("SEM MINIONS! A TORRE FOCA EM VOCÊ!", "dmg");
                takeDamage(player.maxHp * 0.3, "Torre (True Damage)");
            }
        }
        sync();
    } else {
        log(`Caminho inválido. Saídas: ${current.next.join(", ")}`, "sys");
    }
}

function attackBasic() {
    // 1. Prioridade: Heróis na sala
    let targetFound = false;
    Object.values(gameState.players).forEach(p => {
        if (p.id !== myID && p.loc === player.loc && p.team !== player.team) {
            // Calcula dano (Físico reduzido por Defesa)
            let rawDmg = player.ad;
            let reduction = p.def / (p.def + 100);
            let finalDmg = Math.floor(rawDmg * (1 - reduction));
            
            sendEvent(p.id, "damage", { amount: finalDmg, type: "phys" });
            log(`Você atacou ${p.name} causando ${finalDmg} dano.`, "dmg");
            targetFound = true;
            
            // Tiger passiva
            if(player.hero === "tiger") player.stats.stacks = Math.min(100, player.stats.stacks + 10);
        }
    });

    if (!targetFound) {
        // Farmar
        const loc = MAP[player.loc];
        if (loc.mob) {
            log(`Você bateu no ${loc.mob}. Ganhou XP e Gold.`, "item");
            player.gold += 30;
            gainXp(50);
        } else {
            log("Farmou minions. +10g", "item");
            player.gold += 10;
            gainXp(15);
        }
    }
}

function useSkill(slot) {
    if (player.cooldowns[slot] > 0) { log(`Habilidade em recarga: ${player.cooldowns[slot]}s`, "sys"); return; }
    
    // Custo de mana genérico
    if (player.hero !== "tiger" && player.mana < 50) { log("Mana insuficiente.", "sys"); return; }
    if (player.hero !== "tiger") player.mana -= 50;

    player.cooldowns[slot] = 8; // CD Padrão
    
    log(`Usou habilidade [${slot.toUpperCase()}].`, "sys");
    
    // Dano em área na sala
    const dmg = 50 + (player.lvl * 10) + (player.ap * 0.5);
    Object.values(gameState.players).forEach(p => {
        if (p.id !== myID && p.loc === player.loc && p.team !== player.team) {
            sendEvent(p.id, "damage", { amount: dmg, type: "magic" });
        }
    });
}

// === LÓGICA DAS ULTIMATES ===
function useUlt() {
    if (player.cooldowns.r > 0) { log(`ULTIMATE em recarga: ${player.cooldowns.r}s`, "sys"); return; }
    if (player.lvl < 6) { log("Requer Nível 6.", "sys"); return; }

    player.cooldowns.r = 80; // CD Base Ult
    const h = player.hero;

    log(`>>> ATIVANDO ULTIMATE: ${h.toUpperCase()} <<<`, "priv");

    // Lógica Específica
    switch(h) {
        case 'cat': // Cataclismo
            let hitCat = false;
            Object.values(gameState.players).forEach(p => {
                if (p.loc === player.loc && p.team !== player.team) {
                    hitCat = true;
                    if (player.stats.stacks >= 100 || p.hp < (p.maxHp / 2)) {
                        sendEvent(p.id, "damage", { amount: 9999, type: "true" }); // IK
                        log("CATACLISMO EXECUTOU O ALVO!", "dmg");
                    } else {
                        sendEvent(p.id, "effect", { name: "burn", duration: 9 });
                        log("Alvo queimando com Cataclismo.", "dmg");
                    }
                }
            });
            player.stats.stacks = 0; // Reseta barra
            break;

        case 'ladybug': // Talismã
            log("Talismã: Criando item aleatório para aliados na sala...", "item");
            // Cura em área
            sendGlobalEvent("heal_area", { team: player.team, loc: player.loc, amount: 400 });
            break;

        case 'turtle': // Casco
            log("Escudo impenetrável ativado!", "sys");
            player.status.push("shield_immune");
            setTimeout(() => {
                player.status = player.status.filter(s => s !== "shield_immune");
                log("Escudo da Tartaruga terminou.", "sys");
            }, 5000);
            break;

        case 'bee': // Ferroada
            Object.values(gameState.players).forEach(p => {
                if (p.loc === player.loc && p.team !== player.team) {
                    sendEvent(p.id, "effect", { name: "stun", duration: 10 });
                    log(`Você paralisou ${p.name}!`, "sys");
                }
            });
            break;

        case 'fox': // Miragem
            log("Criando ilusões no chat global...", "chat");
            for(let i=0; i<5; i++) {
                setTimeout(() => {
                    const fakeLoc = ["mid", "top_lane", "bot_lane"][Math.floor(Math.random()*3)];
                    sendChat("SISTEMA", `${player.name} foi visto em [${fakeLoc}]`);
                }, i*1000);
            }
            break;

        case 'rabbit': // Toca do Coelho
            log("Voltando no tempo...", "sys");
            // Restaura snapshot de 5s atrás
            if (snapshots.length > 5) {
                const snap = snapshots[snapshots.length - 5];
                player.hp = snap.hp;
                player.loc = snap.loc;
                player.status.push("invuln");
                setTimeout(() => player.status = player.status.filter(s => s!=="invuln"), 2000);
                log("Tempo revertido!", "sys");
                sync();
            }
            break;
            
        case 'snake': // Segunda Chance (Checkpoint)
            log("Marca temporal definida. Você tem 5 minutos (simulado 30s) para voltar.", "sys");
            player.stats.checkpoint = { ...player }; // Deep copy simples
            // Em um jogo real, haveria um comando /revert para ativar.
            // Aqui vamos fazer automático se morrer ou usar de novo.
            break;

        case 'ox': // Touro Resistência
            log("IMUNIDADE TOTAL ATIVADA.", "sys");
            player.status.push("immune_all");
            setTimeout(() => player.status = player.status.filter(s => s!=="immune_all"), 8000);
            break;
            
        case 'butterfly': // Akumatização
            log("Bufando Minions e Torres desta lane!", "sys");
            // Conceitual: aumenta defesa da torre local
            sendChat("SISTEMA", `Borboleta Akumatizou a área ${player.loc}! Torres reforçadas.`);
            break;

        default:
            log("Ultimate genérica disparada (Dano alto em área).", "dmg");
            Object.values(gameState.players).forEach(p => {
                if (p.loc === player.loc && p.team !== player.team) {
                    sendEvent(p.id, "damage", { amount: 500 + (player.ap), type: "magic" });
                }
            });
    }
}

function useFlash() {
    if (player.cooldowns.f > 0) return;
    player.cooldowns.f = 60;
    
    // Pula uma conexão para frente
    const current = MAP[player.loc];
    if (current.next.length > 0) {
        player.loc = current.next[0];
        log(`> FLASH para ${player.loc}`, "sys");
        sync();
    }
}

// === SISTEMA DE LOJA E ITENS ===

function shop(action, itemKey) {
    if (!action) {
        log("--- LOJA (Use: $ buy {item}) ---", "item");
        log("Seus Mini Itens: " + JSON.stringify(MINI_ITEMS), "sys");
        log("Itens Completos (Receitas): " + JSON.stringify(RECIPES), "sys");
        return;
    }

    if (action === 'buy') {
        // Tenta comprar Mini Item
        if (MINI_ITEMS[itemKey]) {
            const it = MINI_ITEMS[itemKey];
            if (player.gold >= it.cost && player.inventory.length < 20) {
                player.gold -= it.cost;
                player.inventory.push(itemKey);
                applyStats(it.stats);
                log(`Comprou ${it.name}.`, "item");
                checkRecipes(); // Tenta fundir
            } else { log("Ouro insuficiente ou inventário cheio.", "dmg"); }
            return;
        }
        
        // Tenta comprar direto Completo (se tiver partes)
        // Simplificado: Compra partes automaticamente se tiver gold
        log("Compre as partes (mini itens) primeiro.", "sys");
    }
}

function checkRecipes() {
    // Verifica se tem partes para um item completo
    for (let key in RECIPES) {
        const recipe = RECIPES[key];
        const hasParts = recipe.parts.every(part => player.inventory.includes(part));
        
        if (hasParts) {
            // Remove partes
            recipe.parts.forEach(part => {
                const idx = player.inventory.indexOf(part);
                player.inventory.splice(idx, 1);
            });
            // Adiciona completo
            player.inventory.push(key);
            applyStats(recipe.stats);
            log(`*** ITEM COMPLETADO: ${recipe.name} ***`, "item");
        }
    }
}

function applyStats(stats) {
    if(stats.hp) player.maxHp += stats.hp;
    if(stats.ad) player.ad += stats.ad;
    if(stats.ap) player.ap += stats.ap;
    if(stats.def) player.def += stats.def;
    if(stats.mana) player.maxMana += stats.mana;
}

function useMagicItem(name) {
    // Exemplo: m poção
    if (name === "cura") {
        player.hp += 200;
        log("Usou item de cura.", "sys");
    }
    // Outros itens mágicos descritos no prompt
}

/* ==========================================================================
   UTILITÁRIOS E REDE
   ========================================================================== */

function gainXp(val) {
    player.xp += val;
    let req = player.lvl * 100;
    if (player.xp >= req) {
        player.lvl++;
        player.xp = 0;
        player.maxHp += 200; player.hp = player.maxHp;
        player.ad += 10;
        log(`SUBIU DE NÍVEL! [${player.lvl}]`, "sys");
    }
}

function takeDamage(amount, type) {
    if (player.status.includes("immune_all")) {
        log("Dano bloqueado (Imunidade)", "sys");
        return;
    }
    if (player.status.includes("shield_immune") && type !== "true") {
        log("Dano bloqueado (Casco)", "sys");
        return;
    }

    // Redução de Dano Simples
    let realDmg = amount;
    if (type === "phys") realDmg = amount * (100 / (100 + player.def));
    if (type === "magic") realDmg = amount * (100 / (100 + player.res));
    
    player.hp -= Math.floor(realDmg);
    log(`Recebeu ${Math.floor(realDmg)} de dano! (${type})`, "dmg");
    
    if (player.hp <= 0) {
        log("VOCÊ MORREU! Renascendo na base...", "dmg");
        player.hp = player.maxHp;
        player.loc = player.team === "blue" ? "base_azul" : "base_red";
        player.gold = Math.max(0, player.gold - 100);
    }
    sync();
}

// LOOP PRINCIPAL (1s)
setInterval(() => {
    // Regeneração Base
    if (MAP[player.loc].type === "base" && player.hp < player.maxHp) player.hp += 50;
    
    // Cooldowns
    for(let k in player.cooldowns) {
        if (player.cooldowns[k] > 0) player.cooldowns[k]--;
    }
    
    // Snapshot para Coelho/Cobra
    snapshots.push({ hp: player.hp, loc: player.loc });
    if(snapshots.length > 60) snapshots.shift(); // Guarda últimos 60s

    renderHUD();
}, 1000);

// RENDERIZAÇÃO
function renderHUD() {
    const loc = MAP[player.loc];
    const enemies = Object.values(gameState.players).filter(p => p.loc === player.loc && p.team !== player.team).length;
    
    const statsHTML = `
[] -> [${player.loc}] ${loc.name}
{} -> {Nv.${player.lvl} ${player.hero || "?"}}
() -> (${player.xp}/${player.lvl*100} XP)
HP: ${Math.floor(player.hp)}/${player.maxHp} | MANA: ${Math.floor(player.mana)}/${player.maxMana}
    `.trim();

    const locHTML = `
STATUS: [${player.status.join(", ")}]
INIMIGOS NA ÁREA: ${enemies}
TORRE: ${loc.type === 'tower' ? (loc.team === player.team ? "Aliada" : "INIMIGA") : "Nenhuma"}
    `.trim();

    const invHTML = `
GOLD: ${player.gold}
ITENS: [${player.inventory.join(", ")}]
SKILLS: Q:${player.cooldowns.q} W:${player.cooldowns.w} E:${player.cooldowns.e} R:${player.cooldowns.r}
    `.trim();

    document.getElementById('hud-stats').innerText = statsHTML;
    document.getElementById('hud-loc').innerText = locHTML;
    document.getElementById('hud-inv').innerText = invHTML;
}

// FIREBASE SYNC
function connectDB() {
    if (!roomID) return;
    const roomRef = db.ref('rooms/' + roomID);
    
    // Atualiza jogador
    const updateSelf = () => {
        roomRef.child('players').child(myID).set({
            id: myID, name: player.name, hero: player.hero, team: player.team,
            loc: player.loc, hp: player.hp, maxHp: player.maxHp, lvl: player.lvl,
            def: player.def // necessário para cálculo de dano dos outros
        });
    };
    
    // Loop de envio (a cada 500ms para economizar banda mas manter responsivo)
    setInterval(updateSelf, 500);

    // Escuta estado global
    roomRef.child('players').on('value', snap => {
        gameState.players = snap.val() || {};
        renderHUD();
    });

    // Escuta Eventos (Dano, Chat)
    roomRef.child('events').on('child_added', snap => {
        const ev = snap.val();
        if (ev.target === myID || ev.target === "ALL") {
            // Processa evento uma vez
            if (ev.type === "damage") takeDamage(ev.amount, ev.evtType);
            if (ev.type === "chat") log(`[${ev.sender}]: ${ev.msg}`, "chat");
            if (ev.type === "effect") {
                log(`Efeito aplicado: ${ev.name}`, "sys");
                player.status.push(ev.name);
                setTimeout(() => player.status = player.status.filter(s => s!==ev.name), ev.duration*1000);
            }
            // Remove do DB para não repetir (simplificado)
            snap.ref.remove(); 
        }
    });
}

function sync() {
    // Gatilho manual de sync se necessário
}

function sendEvent(targetId, type, data) {
    if(!roomID) return;
    db.ref('rooms/' + roomID + '/events').push({
        target: targetId,
        type: type,
        sender: player.name,
        ...data
    });
}

function sendChat(target, msg) {
    if(!roomID) { log(`[LOCAL]: ${msg}`, "chat"); return; }
    db.ref('rooms/' + roomID + '/events').push({
        target: target,
        type: "chat",
        sender: player.hero || player.name,
        msg: msg
    });
}

function sendGlobalEvent(type, data) {
    // Envia para todos na sala
    Object.keys(gameState.players).forEach(pid => sendEvent(pid, "effect", data));
}

function showHelp() {
    log("--- COMANDOS ---", "sys");
    log("/pick [hero] - Escolher herói", "sys");
    log("/move [local] - Mover (ex: mid, t1, base)", "sys");
    log("/a - Ataque Básico", "sys");
    log("/q /w /e /r - Habilidades", "sys");
    log("f - Flash | m [item] - Usar item", "sys");
    log("$ buy [item] - Comprar na loja", "sys");
}

</script>
</body>
</html>
