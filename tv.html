<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∫ Stream TV - Receptor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
        
        /* O Player ocupa a tela toda */
        #video-container { width: 100%; height: 100%; position: relative; }
        #youtube-player, #local-video-player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; border: none; }
        .hidden { display: none !important; }

        /* Sobreposi√ß√£o de Chave */
        #connection-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            text-align: center;
        }
        h1 { font-size: 2em; color: #ff9068; margin-bottom: 10px; }
        #connection-key {
            font-size: 4em; font-weight: bold; padding: 10px 20px;
            border: 4px solid white; border-radius: 10px; letter-spacing: 5px;
            background: #2a5298; cursor: copy;
        }
        #connection-info { margin-top: 20px; color: #ccc; }
        
        /* Bot√£o de Menu para sair do modo TV */
        #back-btn {
            position: fixed; top: 10px; left: 10px; 
            background: rgba(255,255,255,0.2); color: white; 
            padding: 5px 10px; border-radius: 5px; text-decoration: none; 
            z-index: 9999; font-size: 12px; opacity: 0.5;
            transition: opacity 0.3s;
        }
        #back-btn:hover { opacity: 1; }

    </style>
</head>
<body>
    
    <a href="index.html" id="back-btn">‚¨Ö Menu</a>

    <div id="connection-overlay">
        <h1>Stream TV Mode üì∫</h1>
        <p>Aguardando Conex√£o do Controle. Use esta chave:</p>
        <span id="connection-key" title="Clique para Copiar">000000</span>
        <p id="connection-info">Cole esta chave no aplicativo Controle (Celular)</p>
    </div>

    <div id="video-container">
        <div id="youtube-player" class="hidden"></div>
        <video id="local-video-player" class="hidden" controls={false}></video>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- 1. COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI ---
        const firebaseConfig = {
  apiKey: "AIzaSyBv62mYzTKqCTqo-Kfw5ds-GEk67L7_8-I",
  authDomain: "sdfc-c1b59.firebaseapp.com",
  projectId: "sdfc-c1b59",
  storageBucket: "sdfc-c1b59.firebasestorage.app",
  messagingSenderId: "799347293922",
  appId: "1:799347293922:web:df6a9a6f76fcf2bbc9e8bb",
  measurementId: "G-J91HPQWH8F"
};
        // --------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        let db;

        // Vari√°veis
        let player; // YT Player object
        let localPlayer = document.getElementById('local-video-player');
        let isYTReady = false;
        let currentPlaylist = [];
        let connectionKey = localStorage.getItem('tv_connection_key');
        
        // --- L√ìGICA DE GERA√á√ÉO E CONEX√ÉO DA CHAVE ---
        
        function generateKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        if (!connectionKey) {
            connectionKey = generateKey();
            localStorage.setItem('tv_connection_key', connectionKey);
        }

        document.getElementById('connection-key').innerText = connectionKey;
        db = firebase.database().ref(`sessions/${connectionKey}`);
        console.log(`Conectado ao Firebase com a chave: ${connectionKey}`);
        
        // --- FUN√á√ïES YOUTUBE API ---
        
        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('youtube-player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'controls': 0, 'rel': 0, 'playsinline': 1 },
                events: {
                    'onReady': () => { 
                        isYTReady = true; 
                        setupListeners(); // Come√ßa a escutar ap√≥s o player estar pronto
                    },
                    'onStateChange': (e) => {
                        // Se o v√≠deo acabar, avisa o controle (Firebase)
                        if(e.data === YT.PlayerState.ENDED) db.child('status/ended').set(Date.now());
                    }
                }
            });
        };

        // Helpers
        const getYouTubeId = (url) => {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        };
        
        // --- L√ìGICA DE SINCRONIZA√á√ÉO ---
        
        function setupListeners() {
            // Esconde a sobreposi√ß√£o ao conectar
            document.getElementById('connection-overlay').style.display = 'none';

            // 1. Escutar Mudan√ßas na Playlist
            db.child('playlist').on('value', (snapshot) => {
                currentPlaylist = snapshot.val() || [];
            });

            // 2. Escutar Comandos de Estado (√çndice, Play/Pause)
            db.child('state').on('value', (snapshot) => {
                const state = snapshot.val();
                if(!state || currentPlaylist.length === 0) return;

                // Tenta entrar em fullscreen e desbloquear √°udio (requer intera√ß√£o)
                try { 
                    document.body.requestFullscreen(); 
                } catch(e){}

                const videoData = currentPlaylist[state.index];
                if(!videoData) return;

                const ytId = getYouTubeId(videoData.url);

                if (ytId) {
                    // Tocar YouTube
                    localPlayer.classList.add('hidden');
                    localPlayer.pause();
                    document.getElementById('youtube-player').classList.remove('hidden');

                    if(isYTReady) {
                        // S√≥ carrega se o ID mudou
                        if(player.getVideoData().video_id !== ytId) {
                            player.loadVideoById(ytId);
                        }
                        // Estado Play/Pause
                        state.isPlaying ? player.playVideo() : player.pauseVideo();
                    }
                } else {
                    // Tocar Local/MP4
                    document.getElementById('youtube-player').classList.add('hidden');
                    if(isYTReady) player.stopVideo();
                    
                    localPlayer.classList.remove('hidden');
                    
                    // S√≥ recarrega se a URL mudou
                    if(localPlayer.src !== videoData.url) {
                        localPlayer.src = videoData.url;
                    }
                    
                    state.isPlaying ? localPlayer.play() : localPlayer.pause();
                }
            });
            
            // Se o v√≠deo local acabar, avisa o banco
            localPlayer.onended = () => db.child('status/ended').set(Date.now());
        }

        // Adiciona funcionalidade de copiar a chave ao clicar
        document.getElementById('connection-key').addEventListener('click', () => {
            navigator.clipboard.writeText(connectionKey).then(() => {
                const info = document.getElementById('connection-info');
                info.innerText = '‚úÖ CHAVE COPIADA! Cole no controle.';
                setTimeout(() => info.innerText = 'Cole esta chave no aplicativo Controle (Celular)', 3000);
            });
        });
        
        // Tenta iniciar a escuta, caso o YT j√° esteja pronto
        if (isYTReady) setupListeners();
    </script>
</body>
</html>