<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“º Stream TV - Receptor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
        
        /* O Player ocupa a tela toda */
        #video-container { 
            width: 100%; height: 100%; position: relative; 
            filter: brightness(100%); 
            transition: filter 0.5s; 
        }
        /* Iframe simples para YouTube e links Web (maior compatibilidade) */
        #media-player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; border: none; }
        .hidden { display: none !important; }

        /* SobreposiÃ§Ã£o de ConexÃ£o */
        #connection-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            text-align: center;
        }
        h1 { font-size: 2em; color: #ff9068; margin-bottom: 10px; }
        #connection-key {
            font-size: 4em; font-weight: bold; padding: 10px 20px;
            border: 4px solid white; border-radius: 10px; letter-spacing: 5px;
            background: #2a5298; cursor: copy;
        }
        #connection-info { margin-top: 20px; color: #ccc; }
        
        #back-btn {
            position: fixed; top: 10px; left: 10px; 
            background: rgba(255,255,255,0.2); color: white; 
            padding: 5px 10px; border-radius: 5px; text-decoration: none; 
            z-index: 9999; font-size: 12px; opacity: 0.5;
            transition: opacity 0.3s;
        }
        #back-btn:hover { opacity: 1; }

    </style>
</head>
<body>
    
    <a href="index.html" id="back-btn">â¬… Menu</a>

    <div id="connection-overlay">
        <h1>Stream TV Mode ðŸ“º</h1>
        <p>A TV estÃ¡ no ar. Use o nome abaixo no controle:</p>
        <span id="connection-key" title="Clique para Copiar">MYTV</span>
        <p id="connection-info">Este Ã© o nome fixo da sua TV. Clique para copiar.</p>
    </div>

    <div id="video-container">
        <iframe id="media-player" class="hidden" allow="autoplay; fullscreen; encrypted-media; picture-in-picture" frameborder="0"></iframe>
        <video id="local-video-player" class="hidden" controls={false}></video>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- 1. COLE SUA CONFIGURAÃ‡ÃƒO DO FIREBASE AQUI ---
        const firebaseConfig = {
  apiKey: "AIzaSyBv62mYzTKqCTqo-Kfw5ds-GEk67L7_8-I",
  authDomain: "sdfc-c1b59.firebaseapp.com",
  projectId: "sdfc-c1b59",
  storageBucket: "sdfc-c1b59.firebasestorage.app",
  messagingSenderId: "799347293922",
  appId: "1:799347293922:web:df6a9a6f76fcf2bbc9e8bb",
  measurementId: "G-J91HPQWH8F"
};
        // --------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        let db;

        const connectionKey = "MYTV"; 
        
        const localPlayer = document.getElementById('local-video-player');
        const webPlayer = document.getElementById('media-player'); 
        const videoContainer = document.getElementById('video-container');
        let currentPlaylist = [];
        
        // ConfiguraÃ§Ãµes de ConexÃ£o
        document.getElementById('connection-key').innerText = connectionKey;
        db = firebase.database().ref(`sessions/${connectionKey}`);
        
        db.child('metadata').set({
            name: connectionKey, 
            lastSeen: Date.now()
        });

        // Tenta remover a sessÃ£o do Firebase quando a pÃ¡gina for fechada
        try {
             db.onDisconnect().remove();
        } catch(e) { /* Ignora se falhar */ }


        // --- FUNÃ‡Ã•ES DE VÃDEO ---
        
        const getYouTubeId = (url) => {
            if (!url) return null;
            const regExp = /(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.*&v=|shorts\/|playlist\?list=|embed\/videoseries\?list=))([^&?#]+)/;
            const match = url.match(regExp);
            return (match && match[1].length === 11) ? match[1] : null;
        };

        const generateEmbedUrl = (videoId, autoplay = true) => {
             // ForÃ§a autoplay e mostra controles
             const params = `?autoplay=${autoplay ? 1 : 0}&controls=1&rel=0&playsinline=1&modestbranding=1`;
             return `https://www.youtube.com/embed/${videoId}${params}`;
        };
        
        // --- LÃ“GICA DE SINCRONIZAÃ‡ÃƒO E CONTROLES ---
        
        function setupListeners() {
            document.getElementById('connection-overlay').style.display = 'none';

            // 1. Escutar MudanÃ§as na Playlist
            db.child('playlist').on('value', (snapshot) => {
                currentPlaylist = snapshot.val() || [];
            });

            // 2. Escutar Comandos de Estado (Ãndice, Play/Pause)
            db.child('state').on('value', (snapshot) => {
                const state = snapshot.val();
                if(!state) return;
                
                // --- AÃ§Ã£o de Sair do VÃ­deo / Limpar ---
                if (state.clear) {
                    webPlayer.src = ""; 
                    localPlayer.src = "";
                    webPlayer.classList.add('hidden');
                    localPlayer.classList.add('hidden');
                    db.child('state/clear').remove();
                    return;
                }

                if (currentPlaylist.length === 0) return;

                // Tenta entrar em fullscreen
                try { 
                    if (document.fullscreenElement === null) document.body.requestFullscreen(); 
                } catch(e){}

                const videoData = currentPlaylist[state.index];
                if(!videoData) return;

                const ytId = getYouTubeId(videoData.url);

                if (ytId) {
                    // Ã‰ YouTube: Usa o Iframe Player
                    localPlayer.classList.add('hidden');
                    localPlayer.pause();
                    webPlayer.classList.remove('hidden');

                    const embedUrl = generateEmbedUrl(ytId, state.isPlaying);
                    
                    if(webPlayer.src !== embedUrl) {
                        webPlayer.src = embedUrl;
                    }
                    
                    // Se estiver pausado, carregamos o vÃ­deo sem autoplay (autoplay=0)
                    // e contamos com o controle manual dentro do iframe se o user interagir.

                } else {
                    // NÃ£o Ã© YouTube: Assume que Ã© MP4/Link Direto para o Player <video>
                    webPlayer.classList.add('hidden');
                    webPlayer.src = "";
                    
                    localPlayer.classList.remove('hidden');
                    
                    if(localPlayer.src !== videoData.url) {
                        localPlayer.src = videoData.url;
                    }
                    
                    if (state.isPlaying) localPlayer.play().catch(e => console.log("Autoplay falhou no Local")); else localPlayer.pause();
                }
            });

            // 3. Escutar Controles de MÃ­dia (Volume, Brilho)
            db.child('mediaControls').on('value', (snapshot) => {
                const controls = snapshot.val();
                if(!controls) return;
                
                // Volume: SÃ³ afeta o player local <video>
                if (controls.volume !== undefined) {
                    localPlayer.volume = controls.volume;
                }
                
                // Brilho (Implementado via CSS Filter)
                if (controls.brightness !== undefined) {
                    const brightnessValue = Math.max(0.2, controls.brightness);
                    videoContainer.style.filter = `brightness(${brightnessValue * 100}%)`;
                }
            });
            
            // Se o vÃ­deo local acabar, avisa o banco
            localPlayer.onended = () => db.child('status/ended').set(Date.now());
        }

        document.getElementById('connection-key').addEventListener('click', () => {
            navigator.clipboard.writeText(connectionKey).then(() => {
                const info = document.getElementById('connection-info');
                info.innerText = 'âœ… NOME COPIADO! Cole no controle.';
                setTimeout(() => info.innerText = 'Este Ã© o nome fixo da sua TV. Clique para copiar.', 3000);
            });
        });
        
        setupListeners(); 
    </script>
</body>
</html>
