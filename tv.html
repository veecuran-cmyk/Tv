<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∫ Stream TV - Receptor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
        
        /* O Player ocupa a tela toda */
        #video-container { 
            width: 100%; height: 100%; position: relative; 
            /* Aplica o filtro de brilho controlado pelo JS/Firebase */
            filter: brightness(100%); 
            transition: filter 0.5s; 
        }
        #youtube-player, #local-video-player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; border: none; }
        .hidden { display: none !important; }

        /* Sobreposi√ß√£o de Chave */
        #connection-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            text-align: center;
        }
        h1 { font-size: 2em; color: #ff9068; margin-bottom: 10px; }
        #connection-key {
            font-size: 4em; font-weight: bold; padding: 10px 20px;
            border: 4px solid white; border-radius: 10px; letter-spacing: 5px;
            background: #2a5298; cursor: copy;
        }
        #connection-info { margin-top: 20px; color: #ccc; }
        
        /* Bot√£o de Menu para sair do modo TV */
        #back-btn {
            position: fixed; top: 10px; left: 10px; 
            background: rgba(255,255,255,0.2); color: white; 
            padding: 5px 10px; border-radius: 5px; text-decoration: none; 
            z-index: 9999; font-size: 12px; opacity: 0.5;
            transition: opacity 0.3s;
        }
        #back-btn:hover { opacity: 1; }

    </style>
</head>
<body>
    
    <a href="index.html" id="back-btn">‚¨Ö Menu</a>

    <div id="connection-overlay">
        <h1>Stream TV Mode üì∫</h1>
        <p>Aguardando Conex√£o do Controle. Use esta chave:</p>
        <span id="connection-key" title="Clique para Copiar">000000</span>
        <p id="connection-info">Cole esta chave no aplicativo Controle (Celular)</p>
    </div>

    <div id="video-container">
        <div id="youtube-player" class="hidden"></div>
        <video id="local-video-player" class="hidden" controls={false}></video>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- 1. COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI ---
        const firebaseConfig = {
  apiKey: "AIzaSyBv62mYzTKqCTqo-Kfw5ds-GEk67L7_8-I",
  authDomain: "sdfc-c1b59.firebaseapp.com",
  projectId: "sdfc-c1b59",
  storageBucket: "sdfc-c1b59.firebasestorage.app",
  messagingSenderId: "799347293922",
  appId: "1:799347293922:web:df6a9a6f76fcf2bbc9e8bb",
  measurementId: "G-J91HPQWH8F"
};
        // --------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        let db;

        // Vari√°veis e Elementos
        let player; // YT Player object
        const localPlayer = document.getElementById('local-video-player');
        const videoContainer = document.getElementById('video-container');
        let isYTReady = false;
        let currentPlaylist = [];
        let connectionKey = localStorage.getItem('tv_connection_key') || generateKey();
        
        // Fun√ß√µes de Inicializa√ß√£o
        
        function generateKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Configura√ß√µes de Conex√£o
        localStorage.setItem('tv_connection_key', connectionKey);
        document.getElementById('connection-key').innerText = connectionKey;
        db = firebase.database().ref(`sessions/${connectionKey}`);
        
        // Registra a TV como ativa e o nome para o controle
        db.child('metadata').set({
            name: `Tablet TV (${connectionKey})`,
            lastSeen: Date.now()
        });

        // Remove a sess√£o do Firebase quando a p√°gina √© fechada (melhoria)
        db.onDisconnect().remove();

        // --- FUN√á√ïES YOUTUBE API ---
        
        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('youtube-player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'controls': 0, 'rel': 0, 'playsinline': 1, 'autohide': 1, 'showinfo': 0, 'modestbranding': 1 },
                events: {
                    'onReady': () => { 
                        isYTReady = true; 
                        setupListeners(); // Come√ßa a escutar ap√≥s o player estar pronto
                    },
                    'onStateChange': (e) => {
                        if(e.data === YT.PlayerState.ENDED) db.child('status/ended').set(Date.now());
                        // Avisa o controle sobre o estado de pausa (para sincronizar o √≠cone)
                        if(e.data === YT.PlayerState.PLAYING) db.child('state/isPlaying').set(true);
                        if(e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.BUFFERING) db.child('state/isPlaying').set(false);
                    }
                }
            });
        };

        // Toler√¢ncia melhorada para YouTube
        const getYouTubeId = (url) => {
            if (!url) return null;
            // Padr√£o que captura ID de watch, v, youtu.be, shorts e at√© de playlists (apenas o primeiro v√≠deo)
            const regExp = /(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.*&v=|shorts\/|playlist\?list=|embed\/videoseries\?list=))([^&?#]+)/;
            const match = url.match(regExp);
            // Verifica se √© um ID de v√≠deo v√°lido (11 caracteres)
            return (match && match[1].length === 11) ? match[1] : null;
        };
        
        // --- L√ìGICA DE SINCRONIZA√á√ÉO E CONTROLES ---
        
        function setupListeners() {
            // Esconde a sobreposi√ß√£o ao conectar
            document.getElementById('connection-overlay').style.display = 'none';

            // 1. Escutar Mudan√ßas na Playlist
            db.child('playlist').on('value', (snapshot) => {
                currentPlaylist = snapshot.val() || [];
            });

            // 2. Escutar Comandos de Estado (√çndice, Play/Pause)
            db.child('state').on('value', (snapshot) => {
                const state = snapshot.val();
                if(!state) return;
                
                // --- A√ß√£o de Sair do V√≠deo / Limpar ---
                if (state.clear) {
                    player.stopVideo();
                    localPlayer.src = "";
                    document.getElementById('youtube-player').classList.add('hidden');
                    localPlayer.classList.add('hidden');
                    db.child('state/clear').remove();
                    return;
                }

                if (currentPlaylist.length === 0) return;

                // Tenta entrar em fullscreen e desbloquear √°udio (requer intera√ß√£o)
                try { 
                    if (document.fullscreenElement === null) document.body.requestFullscreen(); 
                } catch(e){}

                const videoData = currentPlaylist[state.index];
                if(!videoData) return;

                const ytId = getYouTubeId(videoData.url);

                if (ytId) {
                    // Tocar YouTube
                    localPlayer.classList.add('hidden');
                    localPlayer.pause();
                    document.getElementById('youtube-player').classList.remove('hidden');

                    if(isYTReady) {
                        if(player.getVideoData().video_id !== ytId) {
                            player.loadVideoById(ytId);
                        }
                        if (state.isPlaying) player.playVideo(); else player.pauseVideo();
                    }
                } else {
                    // Tocar Local/MP4
                    document.getElementById('youtube-player').classList.add('hidden');
                    if(isYTReady) player.stopVideo();
                    
                    localPlayer.classList.remove('hidden');
                    
                    if(localPlayer.src !== videoData.url) {
                        localPlayer.src = videoData.url;
                    }
                    
                    if (state.isPlaying) localPlayer.play().catch(e => console.log("Autoplay falhou no Local")); else localPlayer.pause();
                }
            });

            // 3. Escutar Controles de M√≠dia (Volume, Brilho)
            db.child('mediaControls').on('value', (snapshot) => {
                const controls = snapshot.val();
                if(!controls) return;
                
                // Volume
                if (controls.volume !== undefined) {
                    localPlayer.volume = controls.volume;
                    if (isYTReady) player.setVolume(controls.volume * 100);
                }
                
                // Brilho (Implementado via CSS Filter)
                if (controls.brightness !== undefined) {
                    // O valor √© 0-1, transforma para 0%-100% de brilho
                    const brightnessValue = Math.max(0.2, controls.brightness); // M√≠nimo 20%
                    videoContainer.style.filter = `brightness(${brightnessValue * 100}%)`;
                }
            });
            
            // Se o v√≠deo local acabar, avisa o banco
            localPlayer.onended = () => db.child('status/ended').set(Date.now());
        }

        // Adiciona funcionalidade de copiar a chave ao clicar
        document.getElementById('connection-key').addEventListener('click', () => {
            navigator.clipboard.writeText(connectionKey).then(() => {
                const info = document.getElementById('connection-info');
                info.innerText = '‚úÖ CHAVE COPIADA! Cole no controle.';
                setTimeout(() => info.innerText = 'Cole esta chave no aplicativo Controle (Celular)', 3000);
            });
        });
        
        if (isYTReady) setupListeners();
    </script>
</body>
</html>
