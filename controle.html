<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Stream Flex - Controle Remoto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; padding: 15px; margin: 0; }
        
        /* Card de Conex√£o (Inicial) */
        #connection-setup {
            background: #1e1e1e; padding: 25px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; margin-bottom: 20px;
        }
        
        /* Cart√£o de Controle (Ap√≥s Conectar) */
        .remote-card {
            background: #1e1e1e; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; margin-bottom: 20px;
        }
        
        h2 { margin-top: 0; color: #007bff; }
        
        /* Bot√µes Principais */
        .controls { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        
        .btn-round {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: #333; color: white; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .btn-round:active { transform: scale(0.9); }
        .btn-play { background: #007bff; width: 70px; height: 70px; font-size: 30px; }

        /* Input */
        input { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; 
            background: #2a2a2a; color: white; margin-bottom: 10px; box-sizing: border-box; 
            font-size: 16px; 
        }
        .btn-action { 
            width: 100%; padding: 12px; background: #28a745; color: white; border: none; 
            border-radius: 8px; font-weight: bold; cursor: pointer; transition: background 0.2s;
        }
        .btn-action:hover { background: #218838; }

        /* Playlist */
        #playlist { list-style: none; padding: 0; text-align: left; }
        #playlist li {
            padding: 12px; background: #2a2a2a; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px; border-radius: 5px;
        }
        #playlist li.active { border-left: 4px solid #007bff; background: #333; }
        
        .del-btn { background: none; border: none; color: #ff4444; cursor: pointer; font-size: 1.2em; }
        .del-btn:active { transform: scale(0.9); }
        
        .hidden { display: none !important; }
        
        /* Bot√£o Sair/Voltar */
        #disconnect-btn { 
            background: #dc3545; color: white; padding: 10px; border-radius: 8px; 
            margin-top: 15px; font-weight: bold; cursor: pointer; width: 100%; border: none;
        }
    </style>
</head>
<body>

    <div id="connection-setup">
        <h2>Conectar ao Stream TV</h2>
        <p style="color: #ccc;">Insira a chave de 6 d√≠gitos gerada pelo Tablet (Modo TV):</p>
        <input type="text" id="keyInput" placeholder="Ex: A1B2C3" maxlength="6" style="text-transform: uppercase;">
        <button class="btn-action" onclick="connectToTV()">Conectar</button>
        <p id="connection-status" style="color: #ffc107; margin-top: 10px;"></p>
    </div>

    <div id="remote-control-area" class="hidden">
        <div class="remote-card">
            <h2 id="connected-key">Conectado √† [KEY]</h2>
            <div id="now-playing" style="color: #aaa; margin-bottom: 15px; font-style: italic;">
                Nenhum v√≠deo selecionado
            </div>

            <div class="controls">
                <button class="btn-round" onclick="prevVideo()"><i class="fas fa-step-backward"></i></button>
                <button class="btn-round btn-play" onclick="togglePlay()"><i id="play-icon" class="fas fa-play"></i></button>
                <button class="btn-round" onclick="nextVideo()"><i class="fas fa-step-forward"></i></button>
            </div>
            
            <button id="disconnect-btn" onclick="disconnect()">Desconectar</button>
        </div>

        <div class="remote-card">
            <h3>Adicionar V√≠deo</h3>
            <input type="text" id="urlInput" placeholder="Link (YouTube ou MP4)">
            <input type="text" id="titleInput" placeholder="T√≠tulo (Opcional)">
            <button class="btn-action" onclick="addVideo()">Enviar para TV üöÄ</button>
        </div>

        <h3 style="margin-left: 10px;">Fila de Reprodu√ß√£o</h3>
        <ul id="playlist"></ul>
    </div>

    <script>
        // --- 1. COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI ---
        const firebaseConfig = {
  apiKey: "AIzaSyBv62mYzTKqCTqo-Kfw5ds-GEk67L7_8-I",
  authDomain: "sdfc-c1b59.firebaseapp.com",
  projectId: "sdfc-c1b59",
  storageBucket: "sdfc-c1b59.firebasestorage.app",
  messagingSenderId: "799347293922",
  appId: "1:799347293922:web:df6a9a6f76fcf2bbc9e8bb",
  measurementId: "G-J91HPQWH8F"
};
        // --------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        let dbRef; // Refer√™ncia din√¢mica ao Firebase
        let keyInput = document.getElementById('keyInput');

        let playlist = [];
        let currentState = { index: 0, isPlaying: false };
        let currentKey = localStorage.getItem('remote_connection_key');
        
        document.addEventListener('DOMContentLoaded', () => {
            if (currentKey) {
                keyInput.value = currentKey;
                connectToTV(currentKey);
            }
        });

        function connectToTV(key = null) {
            const finalKey = (key || keyInput.value).trim().toUpperCase();
            const status = document.getElementById('connection-status');
            
            if (finalKey.length !== 6) {
                status.innerText = '‚ö†Ô∏è A chave deve ter 6 caracteres.';
                return;
            }
            
            // Define o caminho no Firebase com a chave do usu√°rio
            dbRef = firebase.database().ref(`sessions/${finalKey}`);
            
            // Tenta escrever para verificar se a chave existe ou √© v√°lida (no modo teste)
            dbRef.child('status/connected').set(true).then(() => {
                localStorage.setItem('remote_connection_key', finalKey);
                document.getElementById('connection-setup').classList.add('hidden');
                document.getElementById('remote-control-area').classList.remove('hidden');
                document.getElementById('connected-key').innerText = `Conectado √†: ${finalKey}`;
                setupListeners();
            }).catch(error => {
                status.innerText = `‚ùå Erro de Conex√£o: ${error.message}`;
            });
        }
        
        function disconnect() {
            localStorage.removeItem('remote_connection_key');
            window.location.reload(); // Recarrega para voltar ao setup
        }

        // --- L√ìGICA DE SINCRONIZA√á√ÉO ---
        
        function setupListeners() {
            // 1. Atualiza a Playlist na tela do celular
            dbRef.child('playlist').on('value', (snapshot) => {
                playlist = snapshot.val() || [];
                renderPlaylist();
            });

            // 2. Atualiza os bot√µes (se algu√©m pausar na TV, atualiza o celular)
            dbRef.child('state').on('value', (snapshot) => {
                currentState = snapshot.val() || { index: 0, isPlaying: false };
                updateUI();
            });

            // 3. Escuta se o v√≠deo acabou na TV para pular automaticamente
            dbRef.child('status/ended').on('value', (snapshot) => {
                if(snapshot.val()) nextVideo(false); // N√£o for√ßa o play se j√° tiver terminado
            });
        }

        // --- FUN√á√ïES DE COMANDO ---

        function addVideo() {
            const url = document.getElementById('urlInput').value.trim();
            const title = document.getElementById('titleInput').value.trim() || `V√≠deo ${playlist.length + 1}`;
            
            if(!url) return alert("Insira um link!");

            const newPlaylist = [...playlist, { url, title }];
            dbRef.child('playlist').set(newPlaylist);
            
            // Se for o primeiro v√≠deo, d√° play e carrega o estado
            if(playlist.length === 0) {
                dbRef.child('state').set({ index: 0, isPlaying: true });
            }

            document.getElementById('urlInput').value = '';
            document.getElementById('titleInput').value = '';
        }

        function togglePlay() {
            if (playlist.length === 0) return;
            const newState = !currentState.isPlaying;
            dbRef.child('state/isPlaying').set(newState);
        }

        function prevVideo() {
            if(currentState.index > 0) {
                dbRef.child('state').set({ index: currentState.index - 1, isPlaying: true });
            }
        }

        function nextVideo(forcePlay = true) {
            if(currentState.index < playlist.length - 1) {
                dbRef.child('state').set({ index: currentState.index + 1, isPlaying: forcePlay });
            } else if (forcePlay) {
                // Reinicia a playlist (opcional, mas √∫til)
                dbRef.child('state').set({ index: 0, isPlaying: true });
            }
        }

        window.playSpecific = (index) => {
            dbRef.child('state').set({ index: index, isPlaying: true });
        }

        window.deleteVideo = (index) => {
            if(confirm('Remover v√≠deo?')) {
                const newPlaylist = playlist.filter((_, i) => i !== index);
                dbRef.child('playlist').set(newPlaylist);
                
                // Ajusta √≠ndice
                let newIndex = currentState.index;
                if (index < currentState.index) {
                    newIndex = currentState.index - 1;
                } else if (index === currentState.index) {
                     newIndex = newPlaylist.length > 0 ? 0 : 0;
                     dbRef.child('state').set({ index: newIndex, isPlaying: newPlaylist.length > 0 ? false : false });
                     return;
                }
                dbRef.child('state/index').set(newIndex);
            }
        }

        // --- RENDERIZA√á√ÉO ---

        function updateUI() {
            const icon = document.getElementById('play-icon');
            if(currentState.isPlaying) {
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            } else {
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            }

            if(playlist[currentState.index]) {
                document.getElementById('now-playing').innerText = `Tocando: ${playlist[currentState.index].title}`;
            } else {
                document.getElementById('now-playing').innerText = "Aguardando...";
            }
            renderPlaylist(); // Para atualizar a classe 'active'
        }

        function renderPlaylist() {
            const ul = document.getElementById('playlist');
            ul.innerHTML = '';
            
            playlist.forEach((video, index) => {
                const li = document.createElement('li');
                if(index === currentState.index) li.classList.add('active');
                
                li.innerHTML = `
                    <span onclick="playSpecific(${index})" style="flex-grow:1; cursor:pointer;">
                        ${index + 1}. ${video.title}
                    </span>
                    <button class="del-btn" onclick="deleteVideo(${index})"><i class="fas fa-trash"></i></button>
                `;
                ul.appendChild(li);
            });
        }
    </script>
</body>
</html>