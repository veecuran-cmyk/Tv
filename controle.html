<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Stream Flex - Controle Remoto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; padding: 15px; margin: 0; }
        
        .card {
            background: #1e1e1e; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; margin-bottom: 20px;
        }
        
        h2 { margin-top: 0; color: #007bff; }
        
        /* Controles de M√≠dia */
        .controls { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .controls-row { display: flex; justify-content: space-around; margin-bottom: 15px; }

        .btn-round {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: #333; color: white; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .btn-round:active { transform: scale(0.9); }
        .btn-play { background: #007bff; width: 70px; height: 70px; font-size: 30px; }
        .btn-small { width: 45px; height: 45px; font-size: 18px; }

        /* Input e Bot√µes de A√ß√£o */
        input { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; 
            background: #2a2a2a; color: white; margin-bottom: 10px; box-sizing: border-box; 
            font-size: 16px; 
        }
        .btn-action { 
            width: 100%; padding: 12px; background: #28a745; color: white; border: none; 
            border-radius: 8px; font-weight: bold; cursor: pointer; transition: background 0.2s;
        }
        .btn-action:hover { background: #218838; }

        /* Sliders */
        input[type="range"] { 
            width: 80%; margin: 10px 0;
            -webkit-appearance: none; appearance: none;
            background: #333; height: 8px; border-radius: 5px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; background: #007bff; border-radius: 50%; cursor: pointer;
        }

        /* Playlist */
        #playlist { list-style: none; padding: 0; text-align: left; }
        #playlist li {
            padding: 12px; background: #2a2a2a; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px; border-radius: 5px;
        }
        #playlist li.active { border-left: 4px solid #ff9068; background: #333; }
        
        .del-btn { background: none; border: none; color: #ff4444; cursor: pointer; font-size: 1.2em; }
        .hidden { display: none !important; }
        
        /* Modal (Pop-up de Playlist e Sele√ß√£o de TV) */
        .modal {
            position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #1e1e1e; padding: 30px; border-radius: 15px; width: 80%; max-width: 400px;
            text-align: left; position: relative;
        }
        .modal-content button { margin-top: 10px; }
        
        /* Lista de TVs */
        #tv-list button {
            width: 100%; text-align: left; padding: 10px; margin-bottom: 8px;
            background: #333; color: white; border: none; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="connection-setup" class="card">
        <h2>Conectar ao Stream TV</h2>
        <p id="connection-status" style="color: #ffc107; margin-top: 10px;">Buscando TVs ativas...</p>
        
        <div id="manual-key-entry">
            <p style="color: #ccc; margin-top: 20px;">Ou insira a chave manualmente:</p>
            <input type="text" id="keyInput" placeholder="Ex: A1B2C3" maxlength="6" style="text-transform: uppercase;">
            <button class="btn-action" onclick="connectToTV(document.getElementById('keyInput').value)">Conectar Manualmente</button>
        </div>
        
        <div id="tv-selection-area" class="hidden">
            <p style="color: #ccc; margin-top: 20px;">M√∫ltiplas TVs encontradas. Selecione:</p>
            <div id="tv-list"></div>
        </div>
    </div>

    <div id="remote-control-area" class="hidden">
        
        <div class="card">
            <h2 id="connected-key">Conectado √† [KEY]</h2>
            <div id="now-playing" style="color: #aaa; margin-bottom: 15px; font-style: italic;">
                Nenhum v√≠deo selecionado
            </div>

            <div class="controls">
                <button class="btn-round" onclick="prevVideo()"><i class="fas fa-step-backward"></i></button>
                <button class="btn-round btn-play" onclick="togglePlay()"><i id="play-icon" class="fas fa-play"></i></button>
                <button class="btn-round" onclick="nextVideo()"><i class="fas fa-step-forward"></i></button>
            </div>
            
            <div class="controls-row">
                <button class="btn-round btn-small" onclick="adjustVolume(-0.1)" title="Volume Baixo"><i class="fas fa-volume-down"></i></button>
                <button class="btn-round btn-small" onclick="adjustVolume(0.1)" title="Volume Alto"><i class="fas fa-volume-up"></i></button>
                <button class="btn-round btn-small" onclick="adjustBrightness(-0.1)" title="Brilho Baixo"><i class="fas fa-sun"></i>-</button>
                <button class="btn-round btn-small" onclick="adjustBrightness(0.1)" title="Brilho Alto"><i class="fas fa-sun"></i>+</button>
            </div>

            <button class="btn-action" style="background: #dc3545;" onclick="clearVideo()">
                <i class="fas fa-times-circle"></i> Sair do V√≠deo / Limpar Player
            </button>
        </div>

        <div class="card">
            <h3>Adicionar V√≠deo</h3>
            <input type="text" id="urlInput" placeholder="Link (YouTube, Playlist ou MP4)">
            <input type="text" id="titleInput" placeholder="T√≠tulo (Opcional)">
            <button class="btn-action" onclick="checkAndAddVideo()">Enviar para TV üöÄ</button>
        </div>

        <h3 style="margin-left: 10px;">Fila de Reprodu√ß√£o</h3>
        <ul id="playlist"></ul>
        
        <button id="disconnect-btn" onclick="disconnect()" style="width: 100%; background: #6c757d; border: none; padding: 10px; border-radius: 8px;">
            Desconectar e Voltar ao Menu
        </button>
    </div>

    <div id="playlist-modal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Link de Playlist Detectado</h3>
            <p>Este link parece ser uma playlist. Deseja:</p>
            <button class="btn-action" style="width: 100%; background: #007bff;" onclick="handlePlaylistOption('first')">
                <i class="fas fa-video"></i> Adicionar APENAS o primeiro v√≠deo
            </button>
            <button class="btn-action" style="width: 100%; background: #6c757d; margin-top: 10px;" onclick="handlePlaylistOption('cancel')">
                <i class="fas fa-times"></i> Cancelar e Inserir Outro Link
            </button>
            <p style="font-size: 0.8em; color: #aaa; margin-top: 15px;">*A API do YouTube n√£o permite extrair a playlist completa sem chaves de API complexas.</p>
        </div>
    </div>
    
    <div id="tv-select-modal" class="modal">
        <div class="modal-content">
            <h3>M√∫ltiplas TVs Ativas!</h3>
            <p>Selecione o dispositivo que voc√™ deseja controlar:</p>
            <div id="modal-tv-list"></div>
        </div>
    </div>


    <script>
        // --- 1. COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            databaseURL: "https://SEU_PROJETO-default-rtdb.firebaseio.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "ID"
        };
        // --------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const dbRoot = firebase.database().ref('sessions');
        let dbRef; // Refer√™ncia din√¢mica √† sess√£o da TV
        let keyInput = document.getElementById('keyInput');

        let playlist = [];
        let currentState = { index: 0, isPlaying: false };
        let currentMediaControls = { volume: 0.5, brightness: 1.0 }; // Padr√£o
        let currentKey = localStorage.getItem('remote_connection_key');
        
        // --- Fun√ß√µes de Conex√£o e Inicializa√ß√£o ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Se tiver uma chave salva, tenta conectar diretamente
            if (currentKey) {
                connectToTV(currentKey);
            } else {
                // Se n√£o, busca TVs ativas
                searchActiveTVs();
            }
        });

        function searchActiveTVs() {
            document.getElementById('connection-status').innerText = 'Buscando TVs ativas...';
            dbRoot.once('value', (snapshot) => {
                const sessions = snapshot.val();
                if (!sessions) {
                    document.getElementById('connection-status').innerText = 'Nenhuma TV ativa encontrada. Use a chave manual abaixo.';
                    return;
                }
                
                const activeTVs = [];
                for (const key in sessions) {
                    // Simples filtro de TVs que n√£o foram "removidas" pelo onDisconnect
                    if (sessions[key].metadata && sessions[key].metadata.name) {
                        activeTVs.push({ key: key, name: sessions[key].metadata.name });
                    }
                }
                
                if (activeTVs.length === 0) {
                    document.getElementById('connection-status').innerText = 'Nenhuma TV ativa encontrada. Use a chave manual abaixo.';
                } else if (activeTVs.length === 1) {
                    // Conex√£o Autom√°tica!
                    document.getElementById('connection-status').innerText = `TV √∫nica encontrada: ${activeTVs[0].name}. Conectando...`;
                    connectToTV(activeTVs[0].key);
                } else {
                    // M√∫ltiplas TVs
                    showTVSelection(activeTVs);
                }
            });
        }
        
        function showTVSelection(tvs) {
            const listContainer = document.getElementById('modal-tv-list');
            listContainer.innerHTML = '';
            tvs.forEach(tv => {
                const btn = document.createElement('button');
                btn.innerText = tv.name;
                btn.onclick = () => {
                    document.getElementById('tv-select-modal').style.display = 'none';
                    connectToTV(tv.key);
                };
                listContainer.appendChild(btn);
            });
            document.getElementById('tv-select-modal').style.display = 'flex';
        }

        function connectToTV(key) {
            const finalKey = key.trim().toUpperCase();
            if (finalKey.length !== 6) {
                document.getElementById('connection-status').innerText = '‚ö†Ô∏è A chave deve ter 6 caracteres.';
                return;
            }
            
            dbRef = dbRoot.child(finalKey);
            
            // Verifica se a chave existe (pelo menos a pasta metadata)
            dbRef.child('metadata/name').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                     document.getElementById('connection-status').innerText = `‚ùå TV com chave ${finalKey} n√£o est√° ativa. Tente novamente.`;
                     return;
                }
                
                localStorage.setItem('remote_connection_key', finalKey);
                document.getElementById('connection-setup').classList.add('hidden');
                document.getElementById('remote-control-area').classList.remove('hidden');
                document.getElementById('connected-key').innerText = `Conectado √†: ${snapshot.val()}`;
                setupListeners();
            });
        }
        
        function disconnect() {
            localStorage.removeItem('remote_connection_key');
            // Remove os listeners antigos antes de recarregar
            if (dbRef) dbRef.off(); 
            window.location.href = 'index.html';
        }

        // --- L√ìGICA DE PLAYLIST E V√çDEO ---
        
        // Toler√¢ncia melhorada para YouTube, verificando playlists
        const isPlaylist = (url) => url.includes('list=');

        const getYouTubeId = (url) => {
            if (!url) return null;
            // Captura ID de watch, v, youtu.be, shorts (o mesmo do tv.html)
            const regExp = /(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.*&v=|shorts\/|playlist\?list=|embed\/videoseries\?list=))([^&?#]+)/;
            const match = url.match(regExp);
            return (match && match[1].length === 11) ? match[1] : null;
        };

        function checkAndAddVideo() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return alert("Insira um link!");

            if (isPlaylist(url)) {
                // Abre o pop-up de playlist
                document.getElementById('playlist-modal').style.display = 'flex';
            } else {
                // Adiciona v√≠deo normal
                const title = document.getElementById('titleInput').value.trim() || `V√≠deo ${playlist.length + 1}`;
                addVideoToPlaylist(url, title);
            }
        }
        
        window.handlePlaylistOption = (option) => {
            const url = document.getElementById('urlInput').value.trim();
            document.getElementById('playlist-modal').style.display = 'none';

            if (option === 'first') {
                const ytId = getYouTubeId(url);
                if (ytId) {
                    const videoUrl = `https://www.youtube.com/watch?v=${ytId}`;
                    const title = document.getElementById('titleInput').value.trim() || `Playlist: Primeiro V√≠deo`;
                    addVideoToPlaylist(videoUrl, title);
                } else {
                    alert("N√£o foi poss√≠vel extrair um ID de v√≠deo v√°lido da URL da playlist.");
                }
            } else {
                document.getElementById('urlInput').value = '';
                document.getElementById('titleInput').value = '';
            }
        };

        function addVideoToPlaylist(url, title) {
            const newPlaylist = [...playlist, { url, title }];
            dbRef.child('playlist').set(newPlaylist);
            
            if(playlist.length === 0) {
                dbRef.child('state').set({ index: 0, isPlaying: true });
            }

            document.getElementById('urlInput').value = '';
            document.getElementById('titleInput').value = '';
        }

        // --- FUN√á√ïES DE COMANDO (TELA) ---

        function clearVideo() {
            if (confirm('Tem certeza que deseja limpar o player na TV?')) {
                 dbRef.child('state').set({ index: 0, isPlaying: false, clear: true });
            }
        }

        function togglePlay() {
            if (playlist.length === 0) return;
            const newState = !currentState.isPlaying;
            dbRef.child('state/isPlaying').set(newState);
        }

        function prevVideo() {
            if(currentState.index > 0) {
                dbRef.child('state').set({ index: currentState.index - 1, isPlaying: true });
            }
        }

        function nextVideo() {
            if(currentState.index < playlist.length - 1) {
                dbRef.child('state').set({ index: currentState.index + 1, isPlaying: true });
            } else {
                // Reinicia a playlist
                dbRef.child('state').set({ index: 0, isPlaying: false });
            }
        }
        
        // --- FUN√á√ïES DE COMANDO (M√çDIA) ---
        
        function adjustVolume(delta) {
            currentMediaControls.volume = Math.max(0, Math.min(1, currentMediaControls.volume + delta));
            dbRef.child('mediaControls/volume').set(currentMediaControls.volume);
        }
        
        function adjustBrightness(delta) {
            currentMediaControls.brightness = Math.max(0.3, Math.min(1.0, currentMediaControls.brightness + delta));
            dbRef.child('mediaControls/brightness').set(currentMediaControls.brightness);
        }

        // --- OUVINTES DO FIREBASE ---
        
        function setupListeners() {
            // Atualiza a Playlist na tela do celular
            dbRef.child('playlist').on('value', (snapshot) => {
                playlist = snapshot.val() || [];
                renderPlaylist();
            });

            // Atualiza os bot√µes (estado de Play/Pause e √≠ndice)
            dbRef.child('state').on('value', (snapshot) => {
                currentState = snapshot.val() || { index: 0, isPlaying: false };
                updateUI();
            });

            // Escuta se o v√≠deo acabou na TV para pular automaticamente
            dbRef.child('status/ended').on('value', (snapshot) => {
                if(snapshot.val() && currentState.isPlaying) nextVideo();
            });

            // Sincroniza o estado de volume/brilho no controle
            dbRef.child('mediaControls').on('value', (snapshot) => {
                 currentMediaControls = snapshot.val() || { volume: 0.5, brightness: 1.0 };
            });
        }
        
        // --- RENDERIZA√á√ÉO ---

        function updateUI() {
            const icon = document.getElementById('play-icon');
            if(currentState.isPlaying) {
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            } else {
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            }

            if(playlist[currentState.index]) {
                document.getElementById('now-playing').innerText = `Tocando: ${playlist[currentState.index].title}`;
            } else {
                document.getElementById('now-playing').innerText = "Aguardando...";
            }
            renderPlaylist(); 
        }

        function renderPlaylist() {
            const ul = document.getElementById('playlist');
            ul.innerHTML = '';
            
            playlist.forEach((video, index) => {
                const li = document.createElement('li');
                if(index === currentState.index) li.classList.add('active');
                
                li.innerHTML = `
                    <span onclick="playSpecific(${index})" style="flex-grow:1; cursor:pointer;">
                        ${index + 1}. ${video.title}
                    </span>
                    <button class="del-btn" onclick="deleteVideo(${index})"><i class="fas fa-trash"></i></button>
                `;
                ul.appendChild(li);
            });
        }
        
        window.playSpecific = (index) => dbRef.child('state').set({ index: index, isPlaying: true });
        
        window.deleteVideo = (index) => {
            // Implementa√ß√£o da exclus√£o... (Mantida a mesma l√≥gica anterior, apenas envolta em 'window')
             if(confirm('Remover v√≠deo?')) {
                const newPlaylist = playlist.filter((_, i) => i !== index);
      dbRef.child('playlist').set(newPlaylist);
                
                let newIndex = currentState.index;
                if (index < currentState.index) {
                    newIndex = currentState.index - 1;
                } else if (index === currentState.index) {
                     newIndex = newPlaylist.length > 0 ? 0 : 0;
                     dbRef.child('state').set({ index: newIndex, isPlaying: newPlaylist.length > 0 ? false : false });
                     return;
                }
                dbRef.child('state/index').set(newIndex);
            }
        }
    </script>
</body>
</html>
